<!DOCTYPE html>
<html>
  <head>
    <title>SparkScience Room Demo</title>
  </head>
  <body>
    <input id="room" value="room1" />
    <button onclick="openRoom();" id="room-btn">
      Open Room
    </button><br/>
    <button onclick="leaveRoom();" id="lroom-btn" disabled>
      Leave Room
    </button><br/>
    I am <span id="myName" ></span><br/>
    <video id="local_video" autoplay playsinline muted></video><br/>
    <div id="videos"></div>
    <script
      src="https://code.jquery.com/jquery-2.2.4.min.js"
      integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
      crossorigin="anonymous"
    ></script>
    <script>
      const myPeerConnectionConfig = {
        iceServers: [
          {
            url: 'stun:stun.l.google.com:19302'
          },
          {
            url: 'stun:stun1.l.google.com:19302'
          },
          {
          
            url: 'stun:stun2.l.google.com:19302'
          },
          {
          
            url: 'stun:stun3.l.google.com:19302'
          },
          {
          
            url: 'stun:stun4.l.google.com:19302'
          },
          {
            url: "turn:turn1.turn.group.video:3478",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turn:turn2.turn.group.video:3478",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
          {
            url: "turns:turn1.turn.group.video:443",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turns:turn2.turn.group.video:443",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
        ],
      };
      const myPeerConnections = {};
      const roomMates = [];
      let room = 'room1';
      let socket,
        myName,
        localStream,
        mediaConstraints = (window.constraints = {
            audio: true,
            video: true,
        }),
        iceCandidates = [];
    </script>
    <script>
      function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
      }

      function createPeerConnection(targetUsername, override = false) {
        console.log("room: createPeerConnection");
        console.log('createPeerConnection', targetUsername, override);
        if (!targetUsername) {
            return null;
        }
        if (myPeerConnections[targetUsername] && !override) {
          return myPeerConnections[targetUsername];
        }
        roomMates.push(targetUsername);
        myPeerConnection = new RTCPeerConnection(myPeerConnectionConfig);
        myPeerConnection.onicecandidate = function (event) {
          if (event.candidate) {
            socket.send(
              JSON.stringify({
                type: "new-ice-candidate",
                target: targetUsername,
                candidate: event.candidate,
              })
            );
          }
        };
        myPeerConnection.ontrack = function (event) {
            /*
            if (!document.getElementById("local_video").srcObject) {
              document.getElementById("local_video").srcObject =
                event.streams[0];
              localStream = event.streams[0];

            }
            */
            addVideo(targetUsername, event.streams[0]);
            console.log("Receive Track from", targetUsername);
        };
        myPeerConnection.onnegotiationneeded = function (event) {
          myPeerConnection
            .createOffer()
            .then(function (offer) {
              return myPeerConnection.setLocalDescription(offer);
            })
            .then(function () {
              socket.send(
                JSON.stringify({
                  name: myName,
                  target: targetUsername,
                  type: "video-offer",
                  sdp: myPeerConnection.localDescription,
                })
              );
            })
            .catch(function (e) {
                console.error('onnegotiationneeded error ', { targetUsername }, e);
            });
        };
        myPeerConnection.onremovetrack = function (event) {
          console.log('onremovetrack', targetUsername);
        };
        myPeerConnection.oniceconnectionstatechange = function (event) {
          if(myPeerConnection.iceConnectionState == 'disconnected') {
              console.log('Disconnected', targetUsername , myPeerConnections);
              removeVideo(targetUsername);
              delete myPeerConnections[targetUsername];
          }
        };
        myPeerConnection.onicegatheringstatechange = function (event) {
          console.log('onicegatheringstatechange', targetUsername);
        };
        myPeerConnection.onsignalingstatechange = function (event) {
          console.log('onsignalingstatechange', targetUsername);
        };
        myPeerConnection.onicecandidateerror = (event) => {

        };
        localStream.getTracks().forEach((track) => {
          myPeerConnection.addTrack(track, localStream);
        });
        myPeerConnections[targetUsername] = myPeerConnection;
        return myPeerConnection;
      }

      function addVideo(targetUsername, stream) {
          if ($(`#remote_video-${targetUsername}`).length === 0) {
              console.log({stream});
            $("#videos").append(`<div id="remote-${targetUsername}">This is ${targetUsername} <br/><video id="remote_video-${targetUsername}" autoplay playsinline></video></div>`);
            document.getElementById(`remote_video-${targetUsername}`).srcObject = stream;
          }
      }

      function removeVideo(targetUsername) {
        $("#remote-"+targetUsername).remove();
      }

      async function login() {
        let baseUrl = window.location.href.split("//")[1].split("/")[0];
        let protocol = "wss";
        if (window.location.href.split("//")[0] == "http:") {
          protocol = "ws";
        }
        socket = new WebSocket(`${protocol}://${baseUrl}/room-ws`);

        socket.onopen = function (event) {
          console.log("[socket] Connection established");
          console.log("Sending start to server");
          myName = makeid(10);
          $("#myName").text(myName);
          socket.send(
            JSON.stringify({
              type: "start",
              data: myName,
            })
          );
        };

        socket.onclose = function (event) {
          if (event.wasClean) {
            console.log(
              `[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`
            );
          } else {
            console.log(
              `[close] Connection died, , code=${event.code} reason=${event.reason}`
            );
          }
          // myUsername = "";
          myPeerConnections = [];
          login();
        };

        socket.onerror = function (error) {
          // console.log(`[error] ${error.message}`);
        };

        sleep = async (wait) => {
            return new Promise((resolve) => {
                setTimeout(resolve, wait);
            });
        }

        socket.onmessage = async function (event) {
          // console.log(`[message] Data received from server: ${event.data}`);
          let msg,
            targetUsername,
            myPeerConnection,
            desc;
          try {
            msg = JSON.parse(event.data);
          } catch (e) {
            return;
          }
          msg.data = (msg.Data && !msg.data) ? msg.Data : msg.data;
          msg.type = (msg.Type && !msg.type) ? msg.Type : msg.type;
          // console.log("Message", msg);
          switch (msg.type) {
              case "start":
                if (msg.error) alert(msg.error);
                break;
              case "open-room":
                const users = msg.data.split(',').filter(u => u !== myName);
                console.log({ users });
                for (const targetUsername of users) {
        
                  console.log("room: createPeerConnection1");

                    createPeerConnection(targetUsername);
                    await sleep(1000);
                }
                break;
              case "video-offer":
                targetUsername = msg.name;
        console.log("room: createPeerConnection2");

                myPeerConnection = createPeerConnection(targetUsername);
                desc = new RTCSessionDescription(msg.sdp);
                console.log('video-offer', targetUsername);
                try {
                  await myPeerConnection.setRemoteDescription(desc);
                } catch (e) {
                  console.log("Error setRemoteDescription", {targetUsername}, e);
                }
                let answer;
                try {
                  answer = await myPeerConnection.createAnswer();
                } catch (e) {
                  console.log("Error createAnswer", {targetUsername}, e);
                }
                try {
                  await myPeerConnection.setLocalDescription(answer);

                  socket.send(
                    JSON.stringify({
                      name: myName,
                      target: targetUsername,
                      type: "video-answer",
                      sdp: myPeerConnection.localDescription,
                    })
                  );
                } catch (e) {
                  console.log("Error setLocalDescription", {targetUsername}, e);
                }
                break;
              case "new-ice-candidate":
                // console.log("ICE Canadidate Recieved!", msg);
                targetUsername = msg.name;
        console.log("room: createPeerConnection3");

                myPeerConnection = createPeerConnection(targetUsername);
                iceCandidates.push(new RTCIceCandidate(msg.candidate));
                // console.log(iceCandidates);
                if (myPeerConnection && myPeerConnection.remoteDescription) {
                  // console.log("Adding canadidate");
                  var candidate = iceCandidates.pop();
                  myPeerConnection.addIceCandidate(candidate).catch(function (e) {
                    console.log("new-ice-candidate error:", {targetUsername}, e, candidate);
                  });
                }
                break;
              case "video-answer":
                targetUsername = msg.name;
        
                console.log("room: createPeerConnection4");

                myPeerConnection = createPeerConnection(targetUsername);
                console.log('video-answer', targetUsername);
                desc = new RTCSessionDescription(msg.sdp);
                myPeerConnection.setRemoteDescription(desc).catch((e) => {
                  console.log("Error setRemoteDescription", {targetUsername}, e);
                });
                break;
          }
          /*
          if (msg.type == "video-offer") {
            // console.log("Video Offer Rec!");
            let targetUsername = msg.name;
            targetName = msg.username;
            var desc = new RTCSessionDescription(msg.sdp);
            let myPeerConnection = createPeerConnection(targetUsername, true);
            try {
              await myPeerConnection.setRemoteDescription(desc);
            } catch (e) {
              // console.log("Error setRemoteDescription", e);
            }
            try {
              var answer = await myPeerConnection.createAnswer();
            } catch (e) {
              // console.log("Error createAnswer", e);
            }
            try {
              await myPeerConnection.setLocalDescription(answer);

              socket.send(
                JSON.stringify({
                  name: myUsername,
                  target: targetUsername,
                  type: "video-answer",
                  sdp: myPeerConnection.localDescription,
                })
              );
            } catch (e) {
              console.log("Error setLocalDescription", e);
            }
          } else if (msg.type == "new-ice-candidate") {
            // console.log("ICE Canadidate Recieved!");
            iceCandidates.push(new RTCIceCandidate(msg.candidate));
            // console.log(iceCandidates);
            if (myPeerConnection && myPeerConnection.remoteDescription) {
              // console.log("Adding canadidate");
              var candidate = iceCandidates.pop();
              myPeerConnection.addIceCandidate(candidate).catch(function (e) {
                // console.log("new-ice-candidate error:", e, candidate);
              });
            }
          } else if (msg.type == "video-answer") {
            var desc = new RTCSessionDescription(msg.sdp);
            myPeerConnection.setRemoteDescription(desc).catch((e) => {
              console.log("Error", e);
            });
          } else if (msg.type == "start") {
            if (msg.error) {
              alert(msg.error);
            }
          } else if (msg.type == "role") {
            // console.log("Role Message");
            if (msg.data === "no:broadcast") {
              alert("You are not a broadcaster anymore!");
              socket.close();
            } else if (msg.data === "yes:broadcast") {
              // console.log("Load Stream local", localStream);
              document.getElementById("local_video").srcObject = localStream;
              $("#source-stream").text("Broadcasting");
            } else {
              if (msg.data === "no:audience") {
                // $("#audience-btn").prop("disabled", false);
                // $("#broadcast-btn").prop("disabled", false);
                // $("#source-stream").text("");
                // alert("No broadcast to connect!");
                setTimeout(() => {
                  audience();
                }, 200);
              }
              document.getElementById("local_video").srcObject = null;

            }
          } else if (msg.type == "add_audience") {
            // console.log("add_audience", msg.data);
            connectUser(msg.data);
          } else if (msg.type == "add_broadcast_audience") {
            // console.log("add_audience", msg.data);
            connectUser(msg.data);
          } else if (msg.type == "tree") {
            const treeData = JSON.parse(msg.data);
            console.log({treeData});
            if (lastTree && lastTree === msg.data) {
              return;
            }
            lastTree = msg.data;
            if (treeData && treeData.length > 0) {
              drawGraph(treeData);
            }
          }
          */
        };
      }

      function openRoom(selectedRoom) {
        if (!selectedRoom) {
          selectedRoom = $("#room").val();
          $("#room").prop("disabled", true);
          $("#room-btn").prop("disabled", true);
          $("#lroom-btn").prop("disabled", false);
        }
        room = selectedRoom;
        socket.send(
          JSON.stringify({
            type: "open-room",
            data: selectedRoom,
          })
        );
      }

      function leaveRoom() {
        $("#room").prop("disabled", false);
        $("#room-btn").prop("disabled", false);
        $("#lroom-btn").prop("disabled", true);
      }

      var isWebRTCSupported = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia ||
        window.RTCPeerConnection;
      if (window.navigator.userAgent.indexOf("Edge") === -1 && isWebRTCSupported) {
        navigator.mediaDevices
          .getUserMedia(mediaConstraints)
          .then((ls) => {
            localStream = ls;
            document.getElementById("local_video").srcObject = localStream;
          })
          .catch((e) => {
            console.log("Local St error", e);
          });
        login();
      } else  {
        alert('Unfortunetly your browser does not support this action!');
      }
    </script>
  </body>
</html>