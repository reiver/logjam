<!DOCTYPE html>
  <head>
    <title>SparkScience Broadcast Demo</title>
  </head>
  <body>
    <input type="checkbox" onclick="toggleTurnUsage();" checked /> Use TURN <br/>
    <button id="broadcast-btn" onclick="broadcast();" style="display: none;" >Broadcast</button><br />
    <button id="audience-btn" onclick="audience();">START</button><br />
    <div>
      <h3 style="text-align: center;">
        Status Report
      </h3>
      <button onclick="sendLog('I can see');">I can see</button>
      <button onclick="sendLog('I can`t see');">I can`t see</button>
      <button onclick="sendLog('Image is frozen');">Image is frozen</button>
      <button onclick="const status = prompt('What is the broadcast status?'); if (status) sendLog(status);">Other</button>
    </div>

    <h3 id="source-stream"></h3>
    <h4 id="user-name"></h4>
    <video id="local_video" autoplay playsinline></video><br />
    <video id="local_share" autoplay playsinline></video><br />

    <script
      src="https://code.jquery.com/jquery-2.2.4.min.js"
      integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
      crossorigin="anonymous"
    ></script>
    <script>
      let loggedIn = false;
      let myUsername,
        myName,
        targetName,
        myRole = "audiance";
      let mediaConstraints = (window.constraints = {
        audio: true,
        video: true,
      });
      let localStream,
        remoteStream,
        localScreenShare,
        myPeerConnection,
        myPeerConnections = [],
        iceCandidates = [],
        socket;
      try {
        myName = localStorage.getItem('logjam_myName');
      } catch (e) {
        console.log(e);
      }
      if (confirm(`Do you want to change ${myName} as your name?`)) {
        const newName = prompt('What is you name?');
        if (newName) {
          myName = newName;
          localStorage.setItem('logjam_myName', myName);
        }
      }
      if (myName==='' || !myName) {
        myName = makeid(20);
        try {
          localStorage.setItem('logjam_myName', myName);
        } catch(e) {
          console.log(e);
        }
      }
      function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
      }
      var myPeerConnectionConfig = {
        iceServers: [
          {
            url: 'stun:stun.l.google.com:19302'
          },
          {
            url: 'stun:stun1.l.google.com:19302'
          },
          {
          
            url: 'stun:stun2.l.google.com:19302'
          },
          {
          
            url: 'stun:stun3.l.google.com:19302'
          },
          {
          
            url: 'stun:stun4.l.google.com:19302'
          },
          {
            url: "turn:turn1.turn.group.video:3478",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turn:turn2.turn.group.video:3478",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
          {
            url: "turns:turn1.turn.group.video:443",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turns:turn2.turn.group.video:443",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
        ],
      };

      function createPeerConnection(targetUsername, veiw = "audience") {
        if (myPeerConnections[targetUsername]) {
          return myPeerConnections[targetUsername];
        }
        myPeerConnection = new RTCPeerConnection(myPeerConnectionConfig);
        myPeerConnection.onicecandidate = function (event) {
          if (event.candidate) {
            socket.send(
              JSON.stringify({
                type: "new-ice-candidate",
                target: targetUsername,
                candidate: event.candidate,
              })
            );
          }
        };
        myPeerConnection.ontrack = function (event) {
          if (myRole != "broadcast") {
            if (!document.getElementById("local_video").srcObject) {
              document.getElementById("local_video").srcObject =
                event.streams[0];
              localStream = event.streams[0];
              $("#source-stream").text("Read " + targetName ); //+ "[" + targetUsername + "]");
              socket.send(
                JSON.stringify({
                  type: "stream",
                  data: "true",
                })
              );
              socket.send(
                JSON.stringify({
                  type: "log",
                  data: "ontrack from " + targetName,
                })
              );
            }
          }
        };
        myPeerConnection.onnegotiationneeded = function (event) {
          myPeerConnection
            .createOffer()
            .then(function (offer) {
              return myPeerConnection.setLocalDescription(offer);
            })
            .then(function () {
              socket.send(
                JSON.stringify({
                  name: myUsername,
                  target: targetUsername,
                  type: "video-offer",
                  sdp: myPeerConnection.localDescription,
                })
              );
            })
            .catch(function (e) {
              socket.send(
                JSON.stringify({
                  type: "log",
                  data: "onnegotiationneeded audience error:" + JSON.stringify(e),
                })
              );
            });
        };
        myPeerConnection.onremovetrack = function (event) {};
        myPeerConnection.oniceconnectionstatechange = function (event) {
          socket.send(
            JSON.stringify({
              type: "log",
              data: "oniceconnectionstatechange :" + myPeerConnection.iceConnectionState,
            })
          );
          if(myPeerConnection.iceConnectionState == 'disconnected') {
              console.log('Disconnected', myPeerConnections);
          }
        };
        myPeerConnection.onicegatheringstatechange = function (event) {};
        myPeerConnection.onsignalingstatechange = function (event) {};
        myPeerConnection.onicecandidateerror = (event) => {
          socket.send(
            JSON.stringify({
              type: "log",
              data: "onicecandidateerror :" + JSON.stringify(event),
            })
          );
        };
        myPeerConnections[targetUsername] = myPeerConnection;
        return myPeerConnection;
      }
      function connectUser(targetUsername) {
        // console.log("Connect User", targetUsername);
        if (myPeerConnections[targetUsername]) {
          // console.log("Already Connected");
          return true;
        }
        let myPeerConnection = createPeerConnection(targetUsername);

        // console.log("localStream", localStream);
        if (localStream) {
          localStream.getTracks().forEach((track) => {
            // track["mmcomp"] = "VIDEO";
            myPeerConnection.addTrack(track, localStream);
          });
          // console.log("Added tracks to connection");
        }
      }
      async function login() {
        let baseUrl = window.location.href.split("//")[1].split("/")[0];
        let protocol = "wss";
        if (window.location.href.split("//")[0] == "http:") {
          protocol = "ws";
        }
        socket = new WebSocket(`${protocol}://${baseUrl}/ws`);
        socket.onopen = function (event) {
          // console.log("[open] Connection established");
          // console.log("Sending start to server");
          socket.send(
            JSON.stringify({
              type: "start",
              data: myName,
            })
          );
        };

        socket.onclose = function (event) {
          if (event.wasClean) {
            console.log(
              `[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`
            );
          } else {
            console.log(
              `[close] Connection died, , code=${event.code} reason=${event.reason}`
            );
          }
          // myUsername = "";
          myPeerConnections = [];
          login();
        };

        socket.onerror = function (error) {
          // console.log(`[error] ${error.message}`);
        };

        socket.onmessage = async function (event) {
          // console.log(`[message] Data received from server: ${event.data}`);
          let msg;
          try {
            msg = JSON.parse(event.data);
          } catch (e) {
            return;
          }
          msg.data = (msg.Data && !msg.data) ? msg.Data : msg.data;
          msg.type = (msg.Type && !msg.type) ? msg.Type : msg.type;
          // console.log("Message", msg);
          if (msg.type == "video-offer") {
            // console.log("Video Offer Rec!");
            let targetUsername = msg.name;
            targetName = msg.username;
            var desc = new RTCSessionDescription(msg.sdp);
            let myPeerConnection = createPeerConnection(targetUsername, true);
            try {
              await myPeerConnection.setRemoteDescription(desc);
            } catch (e) {
              // console.log("Error setRemoteDescription", e);
            }
            try {
              var answer = await myPeerConnection.createAnswer();
            } catch (e) {
              // console.log("Error createAnswer", e);
            }
            try {
              await myPeerConnection.setLocalDescription(answer);

              socket.send(
                JSON.stringify({
                  name: myUsername,
                  target: targetUsername,
                  type: "video-answer",
                  sdp: myPeerConnection.localDescription,
                })
              );
            } catch (e) {
              console.log("Error setLocalDescription", e);
            }
          } else if (msg.type == "new-ice-candidate") {
            // console.log("ICE Canadidate Recieved!");
            iceCandidates.push(new RTCIceCandidate(msg.candidate));
            // console.log(iceCandidates);
            if (myPeerConnection && myPeerConnection.remoteDescription) {
              // console.log("Adding canadidate");
              var candidate = iceCandidates.pop();
              myPeerConnection.addIceCandidate(candidate).catch(function (e) {
                // console.log("new-ice-candidate error:", e, candidate);
              });
            }
          } else if (msg.type == "video-answer") {
            var desc = new RTCSessionDescription(msg.sdp);
            myPeerConnection.setRemoteDescription(desc).catch((e) => {
              console.log("Error", e);
            });
          } else if (msg.type == "start") {
            // console.log("START!!");
            if (!msg.error) {
              loggedIn = true;
              myUsername = msg.data
              $("#user-name").text("You are " + myName);// + "[" + myUsername + "]");
              if ($("#audience-btn").prop("disabled")) {
                // console.log("reconnecting as audience");
                audience();
              } else if ($("#broadcast-btn").prop("disabled")) {
                // console.log("reconnecting as broadcast");
                broadcast();
              }
            } else {
              alert(msg.error);
            }
            // console.log("Start", msg, loggedIn);
          } else if (msg.type == "role") {
            // console.log("Role Message");
            if (msg.data === "no:broadcast") {
              alert("You are not a broadcaster anymore!");
              socket.close();
            } else if (msg.data === "yes:broadcast") {
              // console.log("Load Stream local", localStream);
              document.getElementById("local_video").srcObject = localStream;
              $("#source-stream").text("Broadcasting");
            } else {
              if (msg.data === "no:audience") {
                // $("#audience-btn").prop("disabled", false);
                // $("#broadcast-btn").prop("disabled", false);
                // $("#source-stream").text("");
                // alert("No broadcast to connect!");
                setTimeout(() => {
                  audience();
                }, 200);
              }
              document.getElementById("local_video").srcObject = null;

            }
          } else if (msg.type == "add_audience") {
            // console.log("add_audience", msg.data);
            connectUser(msg.data);
          } else if (msg.type == "add_broadcast_audience") {
            // console.log("add_audience", msg.data);
            connectUser(msg.data);
          }
        };
      }

      function broadcast() {
        $("#audience-btn").prop("disabled", false);
        $("#broadcast-btn").prop("disabled", true);
        navigator.mediaDevices
          .getUserMedia(mediaConstraints)
          .then((ls) => {
            localStream = ls;
            // console.log("Local Stream", localStream);
            socket.send(
              JSON.stringify({
                type: "role",
                data: "broadcast",
              })
            );
            const turnStatus = myPeerConnectionConfig.iceServers.findIndex(s => s.url.indexOf('turn:') === 0) >= 0;
            socket.send(
              JSON.stringify({
                type: "turn_status",
                data: turnStatus ? "on" : "off",
              })
            );
          })
          .catch((e) => {
            console.log("Local St error", e);
          });
      }
      function audience() {
        socket.send(
          JSON.stringify({
            type: "role",
            data: "audience",
          })
        );
        const turnStatus = myPeerConnectionConfig.iceServers.findIndex(s => s.url.indexOf('turn:') === 0) >= 0;
        socket.send(
          JSON.stringify({
            type: "turn_status",
            data: turnStatus ? "on" : "off",
          })
        );
        $("#audience-btn").prop("disabled", true);
        $("#broadcast-btn").prop("disabled", false);
        document.getElementById("local_video").srcObject = null;
      }
      function toggleTurnUsage() {
        /*
        const turnRecord = {
          url: "turn:45.149.77.155:3478",
          username: "admin",
          credential: "mmcomp",
        };
        */
        const turnRecord = [
           {
            url: "turn:turn1.turn.group.video:3478",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turn:turn2.turn.group.video:3478",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
          {
            url: "turns:turn1.turn.group.video:443",
            username: "turnuser",
            credential: "dJ4kP05PHcKN8Ubu",
          },
          {
            url: "turns:turn2.turn.group.video:443",
            username: "turnuser",
            credential: "XzfVP8cpNEy17hws",
          },
        ];
        const turnStatus = myPeerConnectionConfig.iceServers.findIndex(s => s.url.indexOf('turn') === 0) >= 0;
        if (turnStatus) {
          myPeerConnectionConfig.iceServers = myPeerConnectionConfig.iceServers.filter(s => s.url.indexOf('turn') < 0);
        } else {
          myPeerConnectionConfig.iceServers.push(...turnRecord);
        }
        console.log(myPeerConnectionConfig);
      }
      function sendLog(log) {
        socket.send(
          JSON.stringify({
            type: "log",
            data: log,
          })
        );
      }
      window.addEventListener("beforeunload", function () {
        if (socket) socket.close();
      });
      var isWebRTCSupported = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia ||
        window.RTCPeerConnection;

      if (window.navigator.userAgent.indexOf("Edge") === -1 && isWebRTCSupported) {
        login();
      } else  {
        alert('Unfortunetly your browser does not support this action!');
      }
    </script>
  </body>
</html>