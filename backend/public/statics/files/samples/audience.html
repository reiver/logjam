<!DOCTYPE html>

<head>
    <title>SparkScience Broadcast Sample</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="./js/spark-rtc.js?v=17"></script>
</head>

<body>
    <label for="myName">Name:</label>
    <input id="roomName" type="text" placeholder="Enter your room" />
    <input id="myName" type="text" placeholder="Enter your name" />
    <button onclick="startReadingBroadcast()">Start Receiving Broadcast</button>
    <button onclick="raisHand()">Raise Hand</button>
    <button onclick="stopVideo()">Stop video</button>
    <button onclick="restartVideo()">Restart video</button>
    <button onclick="stopAudio()">Stop Audio</button>
    <button onclick="restartAudio()">Restart audio</button>
    <h1>Remote Stream</h1>
    <p id="remoteVideos"></p>
    <h1>Local Stream</h1>
    <p>
        <video id="localVideo" playsinline muted style="width: 100px" autoplay></video>
    </p>
    <script>
        const sparkRTC = new SparkRTC('audience', {
            remoteStreamCallback: (stream) => {
                stream.onended = () => {
                    console.log('remote stream ended', stream.id);
                };
                stream.getTracks().forEach(track => {
                    console.log(track);
                    track.onended = () => {
                        console.log('remote track ended', stream.id, track.id);
                    };
                });
                const tagId = 'remoteVideo-' + stream.id;
                if (document.getElementById(tagId)) return;

                addRemoteVideoTag(stream);
            },
            remoteStreamDCCallback: (stream) => {
                const tagId = 'remoteVideo-' + stream.id;
                if (!document.getElementById(tagId)) return;
                console.log('disconnected remote stream', tagId);
                document.getElementById(tagId).remove();
            },
            signalingDisconnectedCallback: () => {
                document.getElementById('remoteVideos').innerHTML = '';
                startReadingBroadcast();
            },
        });

        const setupSignalingSocket = () => {
            const baseUrl = window.location.href.split("//")[1].split("/")[0];
            let protocol = "wss";
            if (window.location.href.split("//")[0] == "http:") {
                protocol = "ws";
            }
            return sparkRTC.setupSignalingSocket(`${protocol}://${baseUrl}/ws`, document.getElementById("myName").value, document.getElementById("roomName").value);
        };

        const startReadingBroadcast = async () => {
            await setupSignalingSocket();
            return sparkRTC.start();
        };

        const raisHand = async () => {
            const localStream = await sparkRTC.raiseHand();
            console.log('raised hand', localStream);
            document.getElementById('localVideo').srcObject = localStream;
        };

        const addRemoteVideoTag = (stream) => {
            const tagId = 'remoteVideo-' + stream.id;
            if (document.getElementById(tagId)) return;

            const videoTag = document.createElement('video');
            videoTag.playsInline = true;
            // videoTag.muted = true;
            videoTag.autoplay = true;
            videoTag.id = tagId;
            videoTag.style.width = '100px';
            videoTag.srcObject = stream;
            document.getElementById('remoteVideos').appendChild(videoTag);
            videoTag.play();
        };

        const stopVideo = () => {
            sparkRTC.disableVideo();
        };

        const restartVideo = () => {
            sparkRTC.disableVideo(true);
        };

        const stopAudio = () => {
            sparkRTC.disableAudio();
        };

        const restartAudio = () => {
            sparkRTC.disableAudio(true);
        };
    </script>
</body>

</html>